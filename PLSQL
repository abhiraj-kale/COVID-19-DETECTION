SET WRAP OFF
SET LINESIZE 32000;
SET PAGESIZE 40000;
SET LONG 50000;

ALTER TABLE SYMPTOMS
ADD PERCENTAGE VARCHAR(10);
ALTER TABLE ZONE_SELECT
ADD PERCENTAGE VARCHAR(10);

CREATE OR REPLACE FUNCTION update_symp(ID IN symptoms.USER_ID%type)
RETURN NUMBER
AS
  tem symptoms.TEMP%type;	
  per symptoms.PERCENTAGE%type;
  U_ID  symptoms.USER_ID%type;
  P_COUGH  symptoms.COUGH%type;
  P_BREATH  symptoms.SHORT_BREATH%type;
  P_NOSE  symptoms.RUNNING_NOSE%type;
  P_PREG  symptoms.PREG%type;
  P_FOREIGN  symptoms.FOREIGN_TRP%type;
BEGIN

  SELECT TEMP
  INTO tem
  FROM symptoms WHERE USER_ID=ID;

  SELECT COUGH
  INTO P_COUGH
  FROM symptoms WHERE USER_ID=ID;

  SELECT SHORT_BREATH
  INTO P_BREATH
  FROM symptoms WHERE USER_ID=ID;

  SELECT RUNNING_NOSE
  INTO P_NOSE
  FROM symptoms WHERE USER_ID=ID;

  SELECT PREG
  INTO P_PREG
  FROM symptoms WHERE USER_ID=ID;

  SELECT FOREIGN_TRP
  INTO P_FOREIGN
  FROM symptoms WHERE USER_ID=ID;

  IF tem<99 THEN
  UPDATE symptoms
  SET percentage='0'
  where TEMP=tem AND USER_ID=ID;

  ELSIF tem>99 AND tem<102 THEN
  UPDATE symptoms
  SET percentage='20'
  where TEMP=tem AND USER_ID=ID;

  ELSIF tem>102 THEN
  UPDATE symptoms
  SET percentage='40'
  where TEMP=tem AND USER_ID=ID;
  END IF;

  IF P_COUGH='Y' OR P_NOSE='Y' OR P_BREATH='Y' THEN
  UPDATE symptoms
  SET PERCENTAGE = (PERCENTAGE + 20) 
  WHERE COUGH = P_COUGH AND SHORT_BREATH = P_BREATH AND  RUNNING_NOSE = P_NOSE AND USER_ID=ID;
  END IF;

  IF (P_COUGH='Y' AND P_BREATH='Y' ) OR (P_COUGH='Y' AND P_NOSE='Y') OR (P_BREATH='Y' AND P_NOSE='Y')  
  THEN
  UPDATE symptoms
  SET PERCENTAGE = (PERCENTAGE + 20) 
  WHERE COUGH = P_COUGH AND SHORT_BREATH = P_BREATH AND  RUNNING_NOSE = P_NOSE AND USER_ID=ID;
  END IF;

  IF (P_COUGH='Y' AND P_BREATH='Y' AND P_NOSE='Y') OR (P_COUGH='Y' AND P_NOSE='Y' AND P_BREATH='Y') OR 
  (P_BREATH='Y' AND P_NOSE='Y' AND P_COUGH='Y')  
  THEN
  UPDATE symptoms
  SET PERCENTAGE = (PERCENTAGE + 20) 
  WHERE COUGH = P_COUGH AND SHORT_BREATH = P_BREATH AND  RUNNING_NOSE = P_NOSE AND USER_ID=ID;
  END IF;

  IF (P_FOREIGN = 'Y')  
  THEN
  UPDATE symptoms
  SET PERCENTAGE = (PERCENTAGE + 10) 
  WHERE FOREIGN_TRP=P_FOREIGN AND USER_ID=ID;
  END IF;

  IF (P_PREG = 'Y')  
  THEN
  UPDATE symptoms
  SET PERCENTAGE = (PERCENTAGE + 10) 
  WHERE PREG=P_PREG AND USER_ID=ID;
  END IF;

  SELECT percentage
  INTO per
  FROM symptoms WHERE USER_ID=ID;

  IF per>100
  THEN 
  UPDATE symptoms
  SET PERCENTAGE = 100
  WHERE USER_ID=ID;
  END IF;
  
  RETURN 0;
END
;
/

CREATE OR REPLACE PROCEDURE SET_ZONES
AS 
BEGIN

UPDATE ZONE_SELECT
SET PERCENTAGE = (
SELECT PERCENTAGE
FROM SYMPTOMS
WHERE SYMPTOMS.USER_ID = ZONE_SELECT.USER_ID
);
 update ZONE_SELECT
SET ZONE= 'G'
WHERE PERCENTAGE<20;
   
update ZONE_SELECT
SET ZONE= 'Y'
WHERE PERCENTAGE>=20 AND PERCENTAGE<40; 

update ZONE_SELECT
SET ZONE= 'R'
WHERE PERCENTAGE>=40;

END;

/

CREATE OR REPLACE TRIGGER UPDATE_ALL
AFTER INSERT ON SUSPECTS
FOR EACH ROW
DECLARE
BEGIN

DECLARE
 NUM NUMBER;
 cursor c1 is
     SELECT USER_ID
     FROM SYMPTOMS;
BEGIN
for I IN c1 LOOP
NUM := update_symp(I.USER_ID);
END loop;
END;
END;
/ 
